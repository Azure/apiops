parameters:
  - name: RESOURCE_GROUP_NAME
    displayName: APIM instance resource group name
    type: string
  - name: AGENT_POOL_NAME
    displayName: Agent pool name
    type: string
  - name: SERVICE_CONNECTION_NAME
    displayName: Service connection name
    type: string

stages:
  - stage: create_artifact_from_portal
    displayName: Create artifact from portal
    jobs:
      - job: create_artifact_from_portal
        displayName: Create artifact from portal
        pool: ${{ parameters.AGENT_POOL_NAME }}
        steps:
          - task: UniversalPackages@0
            displayName: Download creator
            inputs:
              downloadDirectory: '$(Pipeline.Workspace)/creator'
              vstsFeed: $(System.TeamProject)/apim-tools
              vstsFeedPackage: 'creator'
              vstsPackageVersion: '*'
          - task: AzureCLI@2
            displayName: Set creation variables
            inputs:
              azureSubscription: ${{ parameters.SERVICE_CONNECTION_NAME }}
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                echo "##vso[task.setvariable issecret=true;variable=AZURE_BEARER_TOKEN]$(az account get-access-token --query "accessToken" --output tsv)"
                echo "##vso[task.setvariable issecret=true;variable=AZURE_CLIENT_ID]$servicePrincipalId"
                echo "##vso[task.setvariable issecret=true;variable=AZURE_CLIENT_SECRET]$servicePrincipalKey"
                echo "##vso[task.setvariable issecret=true;variable=AZURE_TENANT_ID]$tenantId"
                echo "##vso[task.setvariable issecret=true;variable=AZURE_SUBSCRIPTION_ID]$(az account show --query "id" --output tsv)"
              addSpnToEnvironment: true
              failOnStandardError: true
          - task: AzureCLI@2
            displayName: Run creator
            inputs:
              azureSubscription: ${{ parameters.SERVICE_CONNECTION_NAME }}
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                chmod u+x $(Pipeline.Workspace)/creator/creator
                $(Pipeline.Workspace)/creator/creator
                echo "Exit code is $?"
                exit $?
              addSpnToEnvironment: true
              failOnStandardError: true
            env:
              AZURE_BEARER_TOKEN: $(AZURE_BEARER_TOKEN)
              AZURE_CLIENT_ID: $(AZURE_CLIENT_ID)
              AZURE_CLIENT_SECRET: $(AZURE_CLIENT_SECRET)
              AZURE_TENANT_ID: $(AZURE_TENANT_ID)
              AZURE_SUBSCRIPTION_ID: $(AZURE_SUBSCRIPTION_ID)
              AZURE_RESOURCE_GROUP_NAME: ${{ parameters.RESOURCE_GROUP_NAME }}
              API_MANAGEMENT_SERVICE_OUTPUT_FOLDER_PATH: $(Build.SourcesDirectory)
              COMMIT_ID: $(Build.SourceVersion)